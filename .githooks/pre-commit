#!/usr/bin/env bash

function main() {
  if ! source "$HOME/.config/bash/plugins/log.bash" &>/dev/null; then
    function log::info { echo "[INFO] [$(date -u +%Y-%m-%dT%H:%M:%S.000Z)] $@" >&2; }
    function log::err { echo "[ERROR] [$(date -u +%Y-%m-%dT%H:%M:%S.000Z)] $@" >&2; }
    function log::dev { :; }
  fi

  log::info "Pre-commit hook"

  # Lint (eslint + typescript rules)
  log::info "Running linter..."
  if ! npx eslint . --ext ts,tsx --max-warnings 32 2>&1; then
    log::err "Lint failed — fix errors and warnings before committing"
    exit 1
  fi
  log::info "Lint passed"

  # Format check (prettier)
  log::info "Checking formatting..."
  if ! npx prettier --check 'src/**/*.{ts,tsx}' 2>&1; then
    log::err "Formatting issues — run 'npm run format' then re-stage"
    exit 1
  fi
  log::info "Formatting passed"

  # Tests
  log::info "Running tests..."
  if ! npx vitest run --reporter=dot 2>&1; then
    log::err "Tests failed — aborting commit"
    exit 1
  fi
  log::info "All checks passed"
}
main "$@"
